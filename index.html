<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>全能视频播放器</title>
  <!-- 引入外部资源 -->
  <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-0-y/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-0-y/hls.js/8.0.0-beta.3/hls.js"></script>
  <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-0-y/flv.js/1.6.2/flv.js"></script>

  <style>
    /* 全局样式 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #4a6cf7;
      --primary-dark: #3a57d6;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --border-light: #e2e8f0;
      --border-dark: #334155;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;

      /* 新增：基础间距和字体大小变量，便于响应式调整 */
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 18px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacMacFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
        sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: var(--spacing-md); /* 使用变量 */
      transition: var(--transition);
      font-size: var(--font-size-md); /* 默认字体大小 */
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: #e2e8f0;
      --text-primary: #e2e8f0;
    }

    /* 布局 */
    .container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      gap: var(--spacing-lg); /* 使用变量 */
    }

    /* 卡片样式 */
    .card {
      background: var(--card-light);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      display: flex; /* 新增：使卡片内容居中或按需布局 */
      flex-direction: column; /* 新增：使卡片内容垂直堆叠 */
    }

    .dark-mode .card {
      background: var(--card-dark);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* 头部 */
    header {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .logo i {
      font-size: 28px;
    }

    .logo h1 {
      font-size: var(--font-size-lg);
      font-weight: 700;
    }

    /* 头部右侧按钮容器 */
    .header-buttons {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .theme-toggle,
    .header-settings-toggle-btn,
    .header-history-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .theme-toggle:hover,
    .header-settings-toggle-btn:hover,
    .header-history-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* 头部按钮默认在桌面端隐藏 */
    .header-settings-toggle-btn,
    .header-history-toggle-btn {
      display: none;
    }


    /* 视频播放器区域 */
    .video-wrapper {
      position: relative;
      background: #000; /* 视频区域背景 */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px; /* 确保在没有视频时也有高度 */
      flex-grow: 1; /* 填充可用空间 */
      overflow: hidden; /* 修复旋转时内容溢出 */
      border-radius: 0 0 12px 12px; /* 底部圆角 */
    }

    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 宽高比 */
      background: #000;
      display: none; /* 默认隐藏 */
      overflow: hidden; /* 修复旋转时内容溢出 */
    }

    .video-container.visible {
      display: block; /* 视频加载后显示 */
    }

    /* 全屏模式下的视频容器样式 */
    .video-container.fullscreen-active {
      padding-top: 0 !important;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
    }

    #videoPlayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      outline: none;
      object-fit: contain; /* 确保视频内容适配，可能留黑边 */
      transition: transform 0.1s ease-out, filter 0.1s ease-out;
    }

    /* 全屏模式下的视频播放器样式 */
    .video-container.fullscreen-active #videoPlayer {
      position: static;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 上传占位符 */
    .upload-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: var(--card-light);
      border: 2px dashed var(--border-light);
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      padding: var(--spacing-lg);
      z-index: 1; /* 确保在视频上方 */
    }

    .dark-mode .upload-placeholder {
      background: var(--card-dark);
      border-color: var(--border-dark);
    }

    .upload-placeholder.drag-over {
      border-color: var(--primary);
      background: rgba(74, 108, 247, 0.05);
    }

    .dark-mode .upload-placeholder.drag-over {
      background: rgba(74, 108, 247, 0.1);
    }

    .upload-placeholder.hidden {
      display: none;
    }

    .upload-placeholder i {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: var(--spacing-md);
    }

    .upload-placeholder h3 {
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-sm);
    }

    .upload-placeholder p {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .dark-mode .upload-placeholder p {
      color: #94a3b8;
    }


    /* 控制面板 */
    .control-panel {
      padding: var(--spacing-md) var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md); /* 调整行间距 */
    }

    .control-row {
      display: flex;
      flex-wrap: wrap; /* 允许元素换行 */
      align-items: center;
      gap: var(--spacing-sm); /* 元素间距 */
    }

    .input-group {
      display: flex;
      flex-grow: 1; /* 允许输入框组填充空间 */
      min-width: 200px; /* 最小宽度 */
      gap: var(--spacing-sm);
    }

    .input-group input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      font-size: var(--font-size-md);
      background: transparent;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .dark-mode .input-group input {
      border-color: var(--border-dark);
    }

    .input-group input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .btn-group {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: var(--font-size-md);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: var(--text-primary);
    }

    .dark-mode .btn-secondary {
      background: #334155;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .dark-mode .btn-secondary:hover {
      background: #475569;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* 激活状态按钮 */
    .btn.active-speed-btn,
    .btn.active-preset {
      background-color: var(--primary-dark);
      color: white;
      border-color: var(--primary-dark);
    }

    .dark-mode .btn.active-speed-btn,
    .dark-mode .btn.active-preset {
      background-color: var(--primary);
    }

    /* 预设滤镜按钮 */
    .preset-btn {
      background: var(--card-light);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .dark-mode .preset-btn {
      background: var(--card-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-dark);
    }

    .preset-btn:hover {
      background: #f1f3f5;
    }

    .dark-mode .preset-btn:hover {
      background: #2c3a4f;
    }

    /* 功能区域 (原features) */
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* 调整最小宽度 */
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .feature-card {
      background: rgba(74, 108, 247, 0.08);
      border-radius: 8px;
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: var(--transition);
    }

    .dark-mode .feature-card {
      background: rgba(74, 108, 247, 0.15);
    }

    .feature-card i {
      font-size: 32px;
      color: var(--primary);
      margin-bottom: var(--spacing-sm);
    }

    .feature-card h3 {
      font-size: var(--font-size-md);
      margin-bottom: var(--spacing-sm);
    }

    .feature-card p {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .dark-mode .feature-card p {
      color: #94a3b8;
    }

    /* 历史记录 (现在是浮动面板的一部分) */
    .history-panel .section-header {
      padding: var(--spacing-md) var(--spacing-lg);
      background: rgba(74, 108, 247, 0.1);
      display: flex;
      justify-content: space-between; /* 默认左右对齐 */
      align-items: center;
      border-radius: 12px 12px 0 0; /* 顶部圆角 */
    }

    .dark-mode .history-panel .section-header {
      background: rgba(74, 108, 247, 0.15);
    }

    .history-panel .section-header .history-title-header { /* 新增类名 */
      font-size: var(--font-size-lg);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-shrink: 1; /* 允许标题收缩 */
      min-width: 0; /* 确保在小屏幕下能正确收缩 */
      white-space: nowrap; /* 防止文字换行 */
      overflow: hidden; /* 隐藏溢出部分 */
      text-overflow: ellipsis; /* 显示省略号 */
    }

    .history-list {
      padding: var(--spacing-md);
      max-height: 400px; /* 固定高度，允许滚动 */
      overflow-y: auto;
      flex-grow: 1; /* 填充剩余空间 */
    }

    .history-item {
      padding: var(--spacing-sm) var(--spacing-md);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .dark-mode .history-item {
      border-bottom: 1px solid var(--border-dark);
    }

    .history-item:hover {
      background: rgba(74, 108, 247, 0.05);
    }

    .dark-mode .history-item:hover {
      background: rgba(74, 108, 247, 0.1);
    }

    .history-item .title-wrapper {
      flex: 1;
      min-width: 150px;
      margin-right: var(--spacing-sm);
      display: flex;
      align-items: center;
    }

    .history-item .history-title-display {
      flex: 1;
      word-break: break-word;
      line-height: 1.4;
      min-width: 0;
    }

    .history-item .history-title-edit {
      flex: 1;
      padding: 4px 8px;
      border: 1px solid var(--border-light);
      border-radius: 4px;
      font-size: var(--font-size-sm);
      background: transparent;
      color: var(--text-primary);
      min-width: 100px;
      word-break: break-word;
      line-height: 1.4;
      height: auto;
      resize: vertical;
    }

    .dark-mode .history-item .history-title-edit {
      border-color: var(--border-dark);
    }

    .history-item .actions {
      display: flex;
      gap: 6px; /* 按钮间距 */
      margin-left: auto;
    }

    .history-item .actions button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: var(--transition);
      padding: 5px;
      min-width: 40px;
    }

    .history-item .actions button i {
      font-size: var(--font-size-md);
    }

    .dark-mode .history-item .actions button {
      color: #94a3b8;
    }

    .history-item .actions button:hover {
      background: rgba(74, 108, 247, 0.1);
      color: var(--primary);
    }

    .dark-mode .history-item .actions button:hover {
      background: rgba(74, 108, 247, 0.2);
    }

    .history-item .actions .button-label {
      font-size: 10px;
      color: var(--text-secondary);
      background: var(--card-light);
      padding: 2px 5px;
      border-radius: 4px;
      white-space: nowrap;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .dark-mode .history-item .actions .button-label {
      background: var(--card-dark);
      color: #94a3b8;
    }

    .empty-history {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .dark-mode .empty-history {
      color: #94a3b8;
    }

    /* 状态指示器 */
    .status-indicator {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: var(--font-size-sm);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: var(--spacing-sm);
    }

    .status-indicator.playing {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .status-indicator.stopped {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    .status-indicator.loading {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-indicator i {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    /* 进度条 */
    .progress-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .seek-slider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }

    .dark-mode .seek-slider {
      background: #334155;
    }

    .seek-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }

    .seek-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .time-display {
      font-size: var(--font-size-sm);
      font-weight: 500;
      min-width: 45px;
      text-align: center;
    }

    /* 音量控制 */
    .volume-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
      flex-wrap: wrap; /* 允许换行 */
    }

    .volume-slider-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      min-width: 150px; /* 确保在小屏幕下有足够宽度 */
    }

    .volume-slider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }

    .dark-mode .volume-slider {
      background: #334155;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }

    .volume-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .volume-percentage {
      min-width: 40px;
      text-align: right;
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    /* 字幕控制 */
    .subtitle-controls,
    .subtitle-settings {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .subtitle-select {
      flex: 1;
      min-width: 150px;
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: transparent;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* 注意：这里 SVG 的 xmlns 必须是 http://www.w3.org/2000/svg */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a5568'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 30px;
    }

    .dark-mode .subtitle-select {
      border-color: var(--border-dark);
      background-color: var(--card-dark);
      color: var(--text-primary);
      /* 注意：这里 SVG 的 xmlns 必须是 http://www.w3.org/2000/svg */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    }

    .subtitle-settings label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .dark-mode .subtitle-settings label {
      color: #94a3b8;
    }

    .subtitle-settings input[type='range'] {
      flex: 1;
      min-width: 80px;
      height: 6px;
      -webkit-appearance: none;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }

    .dark-mode .subtitle-settings input[type='range'] {
      background: #334155;
    }

    .subtitle-settings input[type='range']::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }

    .subtitle-settings input[type='range']::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .subtitle-settings input[type='number'] {
      width: 50px;
      padding: 6px 8px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      font-size: var(--font-size-sm);
      background: transparent;
      color: var(--text-primary);
      text-align: center;
    }

    .dark-mode .subtitle-settings input[type='number'] {
      border-color: var(--border-dark);
    }

    .subtitle-settings input[type='color'] {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border-light); /* Added border */
      padding: 0;
      background: none;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
    }
    .dark-mode .subtitle-settings input[type='color'] {
      border-color: var(--border-dark); /* Dark mode border */
    }
    .subtitle-settings input[type='color']::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .subtitle-settings input[type='color']::-webkit-color-swatch {
      border: none;
      border-radius: 8px;
    }

    /* 文件选择按钮 */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* 格式标签 */
    .format-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(74, 108, 247, 0.1);
      color: var(--primary);
      font-size: 12px;
      font-weight: 500;
      margin-left: var(--spacing-sm);
      white-space: nowrap;
    }

    .dark-mode .format-tag {
      background: rgba(74, 108, 247, 0.2);
    }

    /* 示例链接 */
    .example-links {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .example-link {
      padding: 6px 12px;
      background: rgba(74, 108, 247, 0.1);
      border-radius: 20px;
      color: var(--primary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .dark-mode .example-link {
      background: rgba(74, 108, 247, 0.2);
    }

    .example-link:hover {
      background: rgba(74, 108, 247, 0.2);
    }

    .dark-mode .example-link:hover {
      background: rgba(74, 108, 247, 0.3);
    }

    /* 字幕样式 */
    .subtitle-display {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      max-width: 90%;
      padding: 8px 12px;
      color: white;
      font-size: 20px;
      font-weight: 500;
      z-index: 10;
      border-radius: 6px;
      text-align: center;
      line-height: 1.4;
      pointer-events: none;
      display: none;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9), -1px -1px 2px rgba(0, 0, 0, 0.9), 1px -1px 2px rgba(0, 0, 0, 0.9),
        -1px 1px 2px rgba(0, 0, 0, 0.9);
      background-color: transparent; /* Changed from rgba(0, 0, 0, 0.5) to transparent */
    }

    /* 全屏模式下的字幕显示 */
    .video-container.fullscreen-active .subtitle-display {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2147483647;
      max-width: 90%;
      width: auto;
    }

    /* 格式支持提示 */
    .format-support {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(74, 108, 247, 0.05);
      border-radius: 8px;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .dark-mode .format-support {
      background: rgba(74, 108, 247, 0.1);
      color: #94a3b8;
    }

    .supported-formats {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .format-badge {
      padding: 4px 8px;
      background: rgba(74, 108, 247, 0.1);
      border-radius: 4px;
      color: var(--primary);
      font-size: 12px;
    }

    .dark-mode .format-badge {
      background: rgba(74, 108, 247, 0.2);
    }

    /* 设置面板切换按钮 (浮动版本，桌面端可见) */
    .settings-toggle-btn {
      position: fixed;
      top: var(--spacing-md);
      right: var(--spacing-md);
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: var(--transition);
    }

    .settings-toggle-btn:hover {
      background: var(--primary-dark);
      transform: rotate(90deg);
    }

    /* 历史面板切换按钮 (浮动版本，桌面端可见) */
    .history-toggle-btn {
      position: fixed;
      top: var(--spacing-md);
      left: var(--spacing-md);
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: var(--transition);
    }

    .history-toggle-btn:hover {
      background: var(--primary-dark);
      transform: rotate(90deg);
    }


    /* 设置面板 */
    .settings-panel, .history-panel {
      position: fixed;
      top: calc(var(--spacing-md) + 60px); /* 按钮下方 */
      width: 300px;
      background: var(--card-light);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: var(--spacing-md);
      z-index: 999;
      transition: transform 0.3s ease-out, box-shadow 0.3s ease;
    }

    .settings-panel {
      right: var(--spacing-md);
      transform: translateX(calc(100% + var(--spacing-md))); /* 默认隐藏在右侧 */
    }
    .settings-panel.open {
      transform: translateX(0); /* 显示面板 */
    }

    /* 历史面板 */
    .history-panel {
      left: var(--spacing-md);
      transform: translateX(calc(-100% - var(--spacing-md))); /* 默认隐藏在左侧 */
      display: flex; /* 让内容垂直排列 */
      flex-direction: column;
    }
    .history-panel.open {
      transform: translateX(0); /* 显示面板 */
    }

    .dark-mode .settings-panel, .dark-mode .history-panel {
      background: var(--card-dark);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .settings-panel h3, .history-panel h3 {
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-md);
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .settings-panel h4 {
      font-size: var(--font-size-md);
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .settings-panel .setting-group {
      border-bottom: 1px solid var(--border-light);
      padding-bottom: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .dark-mode .settings-panel .setting-group {
      border-color: var(--border-dark);
    }

    .settings-panel .setting-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-panel .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .settings-panel .btn-group .btn {
      flex: 1;
      min-width: unset;
      text-align: center;
      justify-content: center;
    }

    .settings-panel .slider-group {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .settings-panel .slider-group label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      white-space: nowrap;
      min-width: 50px;
    }

    .dark-mode .settings-panel .slider-group label {
      color: #94a3b8;
    }

    .settings-panel .slider-group input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }

    .dark-mode .settings-panel .slider-group input[type="range"] {
      background: #334155;
    }

    .settings-panel .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }

    .settings-panel .slider-group input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .settings-panel .slider-group span {
      font-size: var(--font-size-sm);
      min-width: 40px;
      text-align: right;
      color: var(--text-primary);
    }

    .settings-panel .preset-buttons {
      margin-top: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .settings-panel .btn-full-width {
      width: 100%;
      justify-content: center;
      margin-top: var(--spacing-sm);
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      body {
        padding: var(--spacing-sm);
        font-size: var(--font-size-sm);
      }

      :root {
        --spacing-md: 12px;
        --spacing-lg: 16px;
        --font-size-md: 14px;
        --font-size-lg: 16px;
      }

      .btn {
        padding: 10px 16px;
        font-size: var(--font-size-sm);
      }

      .input-group input {
        font-size: var(--font-size-sm);
      }

      .features {
        grid-template-columns: 1fr;
      }

      .logo h1 {
        font-size: var(--font-size-md);
      }

      .upload-placeholder i {
        font-size: 40px;
      }

      .upload-placeholder h3 {
        font-size: var(--font-size-md);
      }

      .upload-placeholder p {
        font-size: 12px;
      }

      /* 优化控制面板按钮和输入框布局 */
      .control-row {
        flex-direction: column; /* 垂直堆叠 */
        align-items: flex-start; /* 左对齐 */
        width: 100%;
      }

      .input-group {
        flex-direction: column; /* 堆叠输入框和按钮 */
        width: 100%; /* 占据全部宽度 */
        min-width: unset; /* 移除最小宽度限制 */
      }
      .input-group input {
        width: 100%; /* 输入框占据全部宽度 */
      }
      .input-group .btn {
        width: 100%; /* 按钮占据全部宽度 */
        justify-content: center; /* 按钮文字居中 */
      }

      .file-input-wrapper,
      .btn[onclick="downloadVideo()"] { /* 包含下载按钮 */
        width: 100%; /* 使上传和下载按钮占据全部宽度 */
      }
      #uploadLocalBtn {
        width: 100%; /* 确保上传按钮也占据全部宽度 */
        justify-content: center;
      }

      /* 速度控制按钮组 */
      #speedBtnGroup {
        width: 100%; /* 让整个按钮组占据全部宽度 */
        justify-content: space-around; /* 按钮之间均匀分布 */
      }
      #speedBtnGroup .btn {
        flex: 1 1 auto; /* 允许按钮弹性伸缩，尝试占据等宽空间 */
        min-width: unset; /* 移除最小宽度限制 */
      }

      .volume-controls,
      .subtitle-controls,
      .subtitle-settings {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .volume-slider-container,
      .subtitle-select,
      .subtitle-settings .slider-group {
        width: 100%;
        min-width: unset;
      }

      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .history-item .title-wrapper {
        width: 100%;
        margin-right: 0;
      }

      .history-item .format-tag {
        margin-left: 0;
      }

      .history-item .actions {
        width: 100%;
        justify-content: flex-start;
        margin-left: 0;
      }

      /* 隐藏浮动按钮在移动设备上 */
      .settings-toggle-btn,
      .history-toggle-btn {
        display: none;
      }

      /* 显示头部按钮在移动设备上 */
      .header-settings-toggle-btn,
      .header-history-toggle-btn {
        display: flex; /* 使它们可见并参与flex布局 */
      }

      /* 调整面板位置，使其不被头部遮挡 */
      .settings-panel {
        /* 计算头部大致高度：40px (按钮高) + 2 * 12px (上下padding) = 64px */
        top: calc(64px + var(--spacing-sm)); /* 头部高度 + 间距 */
        right: var(--spacing-sm);
        width: calc(100% - var(--spacing-md));
        max-width: 350px;
        transform: translateX(calc(100% + var(--spacing-sm)));
      }

      .settings-panel.open {
        transform: translateX(0);
      }

      .history-panel {
        /* 计算头部大致高度：40px (按钮高) + 2 * 12px (上下padding) = 64px */
        top: calc(64px + var(--spacing-sm)); /* 头部高度 + 间距 */
        left: var(--spacing-sm);
        width: calc(100% - var(--spacing-md));
        max-width: 350px;
        transform: translateX(calc(-100% - var(--spacing-sm)));
      }

      .history-panel.open {
        transform: translateX(0);
      }

      /* 历史面板头部在移动设备下的排版 */
      .history-panel .section-header {
        flex-direction: row; /* 保持行方向 */
        justify-content: flex-end; /* 整体内容靠右 */
      }
      .history-panel .section-header .history-title-header {
        order: 2; /* 标题排在清空按钮之后 */
        margin-left: var(--spacing-sm); /* 与清空按钮保持间距 */
        text-align: right; /* 文本右对齐 */
      }
      .history-panel .section-header .btn {
        order: 1; /* 清空按钮排在标题之前 */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="logo">
          <i class="fas fa-play-circle"></i>
          <h1>全能视频播放器</h1>
        </div>
        <div class="header-buttons"> <!-- 新增的头部按钮容器 -->
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>
          <!-- 移动设备下显示的历史按钮 -->
          <button class="header-history-toggle-btn" id="headerHistoryToggleBtn">
            <i class="fas fa-history"></i>
          </button>
          <!-- 移动设备下显示的设置按钮 -->
          <button class="header-settings-toggle-btn" id="headerSettingsToggleBtn">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </header>

      <div class="video-wrapper">
        <!-- 上传占位符，默认显示 -->
        <div id="uploadPlaceholder" class="upload-placeholder">
          <i class="fas fa-cloud-upload-alt"></i>
          <h3>上传本地视频</h3>
          <p>点击或拖放视频文件到此处</p>
          <p class="text-small">支持所有主流视频格式 (如 MP4, MKV, FLV, WebM 等)</p>
        </div>

        <!-- 视频播放器容器，默认隐藏 -->
        <div class="video-container" id="videoContainer">
          <video id="videoPlayer" controls crossorigin="anonymous"></video>
          <div id="subtitleDisplay" class="subtitle-display" style="display: none;"></div>
        </div>
      </div>

      <div class="control-panel">
        <!-- 播放URL和本地视频上传 -->
        <div class="control-row">
          <div class="input-group">
            <input
              type="text"
              id="videoURL"
              placeholder="输入视频URL (支持所有主流视频格式)"
              value="http://cloud.ruiboyun.net/vod/vod3/e0u83v08/index.m3u8"
            />
            <button class="btn btn-primary" id="playPauseBtn">
              <i class="fas fa-play"></i> <span class="btn-text">播放/暂停</span>
            </button>
            <button class="btn btn-primary" id="reloadVideoBtn">
              <i class="fas fa-sync-alt"></i> 重新加载
            </button>
            <button class="btn btn-danger" onclick="stopPlayback()">
              <i class="fas fa-stop"></i> 停止播放视频
            </button>
          </div>
          <div class="file-input-wrapper">
            <button class="btn btn-success" id="uploadLocalBtn">
              <i class="fas fa-upload"></i> 上传本地视频
            </button>
            <input
              type="file"
              id="fileInput"
              accept="video/mp4,video/webm,video/ogg,video/x-flv,video/quicktime,video/x-msvideo,video/x-ms-wmv,video/3gpp,video/x-matroska,video/avi,video/mpeg,video/mov"
            />
          </div>
          <button class="btn btn-secondary" onclick="downloadVideo()">
            <i class="fas fa-download"></i> 下载视频
          </button>
        </div>

        <!-- 播放速度控制 -->
        <div class="control-row">
          <div class="btn-group" id="speedBtnGroup">
            <button class="btn btn-secondary" data-speed="0.5">
              <i class="fas fa-tachometer-alt"></i> 0.5x
            </button>
            <button class="btn btn-secondary active-speed-btn" data-speed="1">
              <i class="fas fa-tachometer-alt"></i> 1x
            </button>
            <button class="btn btn-secondary" data-speed="1.5">
              <i class="fas fa-tachometer-alt"></i> 1.5x
            </button>
            <button class="btn btn-secondary" data-speed="2">
              <i class="fas fa-tachometer-alt"></i> 2x
            </button>
          </div>
          <button class="btn btn-secondary" onclick="toggleFullscreen()">
            <i class="fas fa-expand"></i> 全屏
          </button>
        </div>

        <!-- 进度条和时间显示 -->
        <div class="progress-controls">
          <div id="currentTimeDisplay" class="time-display">00:00</div>
          <input type="range" min="0" max="0" value="0" step="0.01" class="seek-slider" id="seekSlider">
          <div id="durationDisplay" class="time-display">00:00</div>
        </div>

        <!-- 音量控制 -->
        <div class="volume-controls">
          <div class="volume-slider-container">
            <i class="fas fa-volume-up" id="volumeIcon"></i>
            <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
            <div class="volume-percentage" id="volumePercentage">100%</div>
          </div>
          <button class="btn btn-secondary" onclick="toggleMute()">
            <i class="fas fa-volume-up" id="muteButtonIcon"></i> 静音
          </button>
        </div>

        <!-- 字幕控制 -->
        <div class="control-row">
          <select id="subtitleSelect" class="subtitle-select">
            <option value="none">无字幕</option>
            <!-- 上传字幕选项将通过JS动态添加 -->
          </select>
          <button class="btn btn-secondary" id="uploadSubtitleBtn">
            <i class="fas fa-file-upload"></i> 上传字幕文件 (.srt, .vtt)
          </button>
          <button class="btn btn-secondary" id="toggleSubtitleBtn">
            <i class="fas fa-eye-slash"></i> 显示/隐藏字幕
          </button>
        </div>

        <!-- 字幕样式设置 -->
        <div class="subtitle-settings">
          <label for="subtitleSizeSlider">字幕大小:</label>
          <input type="range" id="subtitleSizeSlider" min="12" max="48" value="20" />
          <input
            type="number"
            id="subtitleSizeValue"
            min="12"
            max="48"
            value="20"
            class="small-input"
            style="width: 50px;"
          />
          px

          <label for="subtitleColorPicker">颜色:</label>
          <input type="color" id="subtitleColorPicker" value="#FFFFFF" />
        </div>

        <div id="statusIndicator" class="status-indicator stopped">
          <i class="fas fa-circle"></i> 播放器已停止
        </div>

        <div class="features">
          <div class="feature-card">
            <i class="fas fa-film"></i>
            <h3>全格式支持</h3>
            <p>支持所有主流视频格式</p>
          </div>
          <div class="feature-card">
            <i class="fas fa-closed-captioning"></i>
            <h3>完整字幕功能</h3>
            <p>外挂字幕支持，可调样式</p>
          </div>
          <div class="feature-card">
            <i class="fas fa-sliders-h"></i>
            <h3>高级控制</h3>
            <p>无极音量调节，播放速度控制</p>
          </div>
          <div class="feature-card">
            <i class="fas fa-cloud"></i>
            <h3>在线播放</h3>
            <p>支持所有主流视频链接</p>
          </div>
        </div>

        <div class="format-support">
          <p><strong>支持的视频格式:</strong></p>
          <div class="supported-formats">
            <span class="format-badge">MP4</span>
            <span class="format-badge">M3U8</span>
            <span class="format-badge">FLV</span>
            <span class="format-badge">WebM</span>
            <span class="format-badge">MKV</span>
            <span class="format-badge">MOV</span>
            <span class="format-badge">AVI</span>
            <span class="format-badge">WMV</span>
            <span class="format-badge">3GP</span>
            <span class="format-badge">OGG</span>
            <span class="format-badge">MPEG</span>
            <span class="format-badge">VOB</span>
            <span class="format-badge">TS</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 浮动按钮打开设置面板 (桌面端可见) -->
  <button class="settings-toggle-btn" id="settingsToggleBtn">
    <i class="fas fa-cog"></i>
  </button>

  <!-- 浮动按钮打开历史面板 (桌面端可见) -->
  <button class="history-toggle-btn" id="historyToggleBtn">
    <i class="fas fa-history"></i>
  </button>

  <!-- 设置面板 -->
  <div class="settings-panel" id="settingsPanel">
    <h3><i class="fas fa-sliders-h"></i> 视频设置</h3>

    <div class="setting-group">
      <h4>画面调节</h4>
      <div class="btn-group">
        <button class="btn btn-secondary" id="rotate90Btn"><i class="fas fa-redo-alt"></i> 旋转 90°</button>
        <button class="btn btn-secondary" id="flipXBtn"><i class="fas fa-arrows-alt-h"></i> 水平镜像</button>
        <button class="btn btn-secondary" id="flipYBtn"><i class="fas fa-arrows-alt-v"></i> 垂直镜像</button>
      </div>
      <div class="slider-group">
        <label for="zoomSlider">缩放:</label>
        <input type="range" id="zoomSlider" min="50" max="300" step="1" value="100" />
        <span id="zoomValue">100%</span>
      </div>
      <button class="btn btn-secondary btn-full-width" id="resetTransformBtn"><i class="fas fa-sync-alt"></i> 重置画面</button>
    </div>

    <div class="setting-group">
      <h4>滤镜调节</h4>
      <div class="slider-group">
        <label for="brightnessSlider">亮度:</label>
        <input type="range" id="brightnessSlider" min="0" max="200" step="1" value="100" />
        <span id="brightnessValue">100%</span>
      </div>
      <div class="slider-group">
        <label for="contrastSlider">对比度:</label>
        <input type="range" id="contrastSlider" min="0" max="200" step="1" value="100" />
        <span id="contrastValue">100%</span>
      </div>
      <div class="slider-group">
        <label for="saturationSlider">饱和度:</label>
        <input type="range" id="saturationSlider" min="0" max="200" step="1" value="100" />
        <span id="saturationValue">100%</span>
      </div>
      <!-- 新增锐化滤镜 -->
      <div class="slider-group">
        <label for="sharpenSlider">锐化:</label>
        <input type="range" id="sharpenSlider" min="0" max="10" step="1" value="0" />
        <span id="sharpenValue">0</span>
      </div>

      <div class="btn-group preset-buttons" id="filterPresetsContainer">
        <button class="btn btn-secondary preset-btn" data-preset="vibrant">鲜艳</button>
        <button class="btn btn-secondary preset-btn" data-preset="cinematic">电影</button>
        <button class="btn btn-secondary preset-btn" data-preset="monochrome">黑白</button>
      </div>
      <button class="btn btn-secondary btn-full-width" id="resetFilterBtn"><i class="fas fa-sync-alt"></i> 重置滤镜</button>
    </div>
  </div>

  <!-- 历史面板 -->
  <div class="history-panel" id="historyPanel">
    <div class="section-header">
      <h2 class="history-title-header"><i class="fas fa-history"></i> 播放历史</h2>
      <button class="btn btn-danger" onclick="clearHistory()">
        <i class="fas fa-trash"></i> 清空
      </button>
    </div>
    <div class="history-list" id="historyList">
      <!-- 历史记录将通过JS动态添加 -->
    </div>
  </div>

  <!-- SVG 滤镜定义，用于锐化效果 -->
  <svg id="sharpen-svg-filters" style="display:none;width:0;height:0;position:absolute;">
    <!-- 滤镜将通过 JavaScript 动态生成 -->
    <!-- 注意：SVG 的 xmlns 属性必须是 http://www.w3.org/2000/svg -->
  </svg>

  <script>
    let hlsInstance = null;
    let flvPlayer = null;
    let currentVideoUrl = null; // 当前播放视频的URL (可以是网络URL或blob:URL)
    let currentVideoIsLocal = false; // 标记当前播放的是否是本地文件
    let currentLocalFileObject = null; // 新增：存储当前播放的本地文件对象
    let currentLocalFileName = null; // 新增：存储当前播放的本地文件名
    let playbackHistory = JSON.parse(localStorage.getItem('playbackHistory')) || []; // 播放历史记录
    let currentSubtitleTracks = []; // 存储解析后的字幕对象 { start, end, text }
    let subtitleActive = false; // 控制自定义字幕显示是否激活
    let currentSubtitleFileName = null; // 当前加载的字幕文件名
    let isSeeking = false; // 用于标记用户是否正在拖动进度条

    // 用于跟踪当前正在编辑的历史项索引，-1表示没有项在编辑
    let currentlyEditingIndex = -1;
    // 存储对输入框事件监听器的引用，以便在保存时正确移除
    const inputEventListeners = new Map(); // Map<index, {blurHandler, keypressHandler}>

    // 支持的视频格式列表 (用于文件扩展名检查)
    const supportedFormats = [
      'mp4', 'm3u8', 'flv', 'webm', 'mkv', 'mov', 'avi', 'wmv', '3gp', 'ogg', 'mpg', 'mpeg', 'vob', 'ts',
    ];

    // 字幕设置的默认值
    const defaultSubtitleSettings = {
      fontSize: 20,
      color: '#FFFFFF',
    };
    let currentSubtitleSettings = JSON.parse(localStorage.getItem('subtitleSettings')) || defaultSubtitleSettings;

    // 视频画面变换设置
    const transformSettings = {
      rotate: 0, // 0, 90, 180, 270 度
      scaleX: 1, // 1 为正常，-1 为水平翻转
      scaleY: 1, // 1 为正常，-1 为垂直翻转
      zoom: 100, // 缩放百分比 (50-300)
    };

    // 视频滤镜设置
    const filterSettings = {
      brightness: 100, // 0-200%
      contrast: 100, // 0-200%
      saturation: 100, // 0-200%
      sharpen: 0, // 锐化强度 (0-10)
    };

    // 滤镜预设值 (不包含锐化)
    const filterPresets = {
      vibrant: { brightness: 105, contrast: 110, saturation: 150, sharpen: 0 },
      cinematic: { brightness: 95, contrast: 120, saturation: 80, sharpen: 0 },
      monochrome: { brightness: 100, contrast: 100, saturation: 0, sharpen: 0 },
    };

    // 播放器DOM元素引用
    let videoPlayer, playPauseBtn, playPauseIcon, playPauseText, reloadVideoBtn,
        uploadPlaceholder, videoContainerElement,
        seekSlider, currentTimeDisplay, durationDisplay,
        volumeSlider, volumePercentage, volumeIcon, muteButtonIcon,
        subtitleSizeSlider, subtitleSizeValue, subtitleColorPicker, subtitleDisplay,
        settingsToggleBtn, headerSettingsToggleBtn, settingsPanel,
        historyToggleBtn, headerHistoryToggleBtn, historyPanel,
        rotate90Btn, flipXBtn, flipYBtn, zoomSlider, zoomValueSpan, resetTransformBtn,
        brightnessSlider, brightnessValueSpan, contrastSlider, contrastValueSpan,
        saturationSlider, saturationValueSpan, sharpenSlider, sharpenValueSpan,
        resetFilterBtn, filterPresetsContainer, speedBtnGroup;


    // 初始化页面
    document.addEventListener('DOMContentLoaded', function () {
      // 获取DOM元素引用
      videoPlayer = document.getElementById('videoPlayer');
      playPauseBtn = document.getElementById('playPauseBtn'); // 更新ID
      playPauseIcon = playPauseBtn.querySelector('i');
      playPauseText = playPauseBtn.querySelector('.btn-text');
      reloadVideoBtn = document.getElementById('reloadVideoBtn'); // 新增按钮
      uploadPlaceholder = document.getElementById('uploadPlaceholder');
      videoContainerElement = document.getElementById('videoContainer');
      seekSlider = document.getElementById('seekSlider');
      currentTimeDisplay = document.getElementById('currentTimeDisplay');
      durationDisplay = document.getElementById('durationDisplay');
      volumeSlider = document.getElementById('volumeSlider');
      volumePercentage = document.getElementById('volumePercentage');
      volumeIcon = document.getElementById('volumeIcon');
      muteButtonIcon = document.getElementById('muteButtonIcon');
      subtitleSizeSlider = document.getElementById('subtitleSizeSlider');
      subtitleSizeValue = document.getElementById('subtitleSizeValue');
      subtitleColorPicker = document.getElementById('subtitleColorPicker');
      subtitleDisplay = document.getElementById('subtitleDisplay');
      
      // 浮动按钮
      settingsToggleBtn = document.getElementById('settingsToggleBtn');
      historyToggleBtn = document.getElementById('historyToggleBtn');
      // 头部按钮
      headerSettingsToggleBtn = document.getElementById('headerSettingsToggleBtn');
      headerHistoryToggleBtn = document.getElementById('headerHistoryToggleBtn');

      settingsPanel = document.getElementById('settingsPanel');
      historyPanel = document.getElementById('historyPanel');
      rotate90Btn = document.getElementById('rotate90Btn');
      flipXBtn = document.getElementById('flipXBtn');
      flipYBtn = document.getElementById('flipYBtn');
      zoomSlider = document.getElementById('zoomSlider');
      zoomValueSpan = document.getElementById('zoomValue');
      resetTransformBtn = document.getElementById('resetTransformBtn');
      brightnessSlider = document.getElementById('brightnessSlider');
      brightnessValueSpan = document.getElementById('brightnessValue');
      contrastSlider = document.getElementById('contrastSlider');
      contrastValueSpan = document.getElementById('contrastValue');
      saturationSlider = document.getElementById('saturationSlider');
      saturationValueSpan = document.getElementById('saturationValue');
      sharpenSlider = document.getElementById('sharpenSlider');
      sharpenValueSpan = document.getElementById('sharpenValue');
      resetFilterBtn = document.getElementById('resetFilterBtn');
      filterPresetsContainer = document.getElementById('filterPresetsContainer');
      speedBtnGroup = document.getElementById('speedBtnGroup');


      // 加载主题设置
      loadTheme();

      // 渲染历史记录 (现在渲染到浮动面板中)
      renderHistory();

      // 设置拖放区域功能
      setupDragAndDrop();

      // 修复：点击上传占位符区域触发文件选择
      uploadPlaceholder.addEventListener('click', () => {
          // 只有当占位符可见时（即没有视频正在播放）才触发文件输入
          if (!videoContainerElement.classList.contains('visible')) {
              document.getElementById('fileInput').click();
          }
      });

      // 设置播放器事件监听 (包含进度条)
      setupPlayerEvents();

      // 设置音量控制
      setupVolumeControl();

      // 设置字幕样式控制
      setupSubtitleSettings();

      // 设置设置面板及其控制
      setupSettingsPanel();

      // 设置历史面板及其控制
      setupHistoryPanel();

      // 创建锐化滤镜的 SVG 元素
      createSharpenSVGElements();

      // 加载所有保存的设置 (字幕、画面、滤镜、播放速度)
      loadAllSettings();

      // 绑定上传本地视频按钮
      document.getElementById('uploadLocalBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      // 绑定上传字幕按钮
      document.getElementById('uploadSubtitleBtn').addEventListener('click', () => {
        uploadSubtitleFile();
      });

      // 监听本地视频文件选择
      document.getElementById('fileInput').addEventListener('change', function () {
        if (this.files && this.files[0]) {
          playLocalVideo(this.files[0]);
          this.value = ''; // 清空，允许重复上传同一个文件也触发
        }
      });

      // 绑定播放/暂停按钮的点击事件
      playPauseBtn.addEventListener('click', handlePlayPause); // 更新事件监听器

      // 绑定重新加载按钮的点击事件
      reloadVideoBtn.addEventListener('click', reloadVideo); // 新增事件监听器

      // 绑定URL输入框的回车事件
      document.getElementById('videoURL').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          handlePlayPause(); // 回车键默认执行播放/暂停逻辑
        }
      });

      // 初始化字幕显示/隐藏按钮的图标
      updateToggleSubtitleButtonIcon();
      // 初始化静音按钮的图标
      updateMuteButtonIcon();

      // 为历史记录列表添加事件委托，处理编辑/保存按钮点击
      // 注意：historyList 现在在 historyPanel 内部
      const historyList = document.getElementById('historyList');
      historyList.addEventListener('click', function(e) {
        const targetBtn = e.target.closest('.edit-save-btn');
        if (targetBtn) {
          const index = parseInt(targetBtn.dataset.index);
          const action = targetBtn.dataset.action;

          if (action === 'edit') {
            startEditMode(index);
          } else if (action === 'save' && currentlyEditingIndex === index) {
            // 只有当按钮是当前正在编辑的项的保存按钮时才触发保存
            saveEditMode(index);
          }
        }
      });

      // 监听全屏状态变化，以便调整视频样式
      document.addEventListener('fullscreenchange', handleFullscreenChange);

      // 绑定播放速度按钮
      speedBtnGroup.addEventListener('click', (e) => {
        const targetBtn = e.target.closest('.btn');
        if (targetBtn && targetBtn.dataset.speed) {
          changeSpeed(parseFloat(targetBtn.dataset.speed), targetBtn);
        }
      });

      // 绑定字幕显示/隐藏按钮
      document.getElementById('toggleSubtitleBtn').addEventListener('click', toggleSubtitle);

      // 添加全局点击事件监听器，用于关闭面板
      document.addEventListener('click', handleOutsideClick);
    });

    // --- 全局点击处理函数，用于关闭面板 ---
    function handleOutsideClick(event) {
        // 检查点击是否在设置面板或其触发按钮之外
        const isClickInsideSettingsPanel = settingsPanel.contains(event.target) || settingsToggleBtn.contains(event.target) || headerSettingsToggleBtn.contains(event.target);
        if (settingsPanel.classList.contains('open') && !isClickInsideSettingsPanel) {
            settingsPanel.classList.remove('open');
        }

        // 检查点击是否在历史面板或其触发按钮之外
        const isClickInsideHistoryPanel = historyPanel.contains(event.target) || historyToggleBtn.contains(event.target) || headerHistoryToggleBtn.contains(event.target);
        if (historyPanel.classList.contains('open') && !isClickInsideHistoryPanel) {
            historyPanel.classList.remove('open');
        }
    }

    // --- 全屏状态变化处理 ---
    function handleFullscreenChange() {
        const videoContainer = document.getElementById('videoContainer');
        if (document.fullscreenElement) {
            // 进入全屏
            videoContainer.classList.add('fullscreen-active');
            applyVideoTransformations(); // 重新应用变换
            applyVideoFilters(); // 重新应用滤镜
        } else {
            // 退出全屏
            videoContainer.classList.remove('fullscreen-active');
            applyVideoTransformations(); // 重新应用变换
            applyVideoFilters(); // 重新应用滤镜
        }
    }

    // --- 设置面板及其控制 ---
    function setupSettingsPanel() {
      // 浮动按钮
      settingsToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到 document，避免立即关闭
        settingsPanel.classList.toggle('open');
        if (historyPanel.classList.contains('open')) {
          historyPanel.classList.remove('open');
        }
      });
      // 头部按钮
      headerSettingsToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到 document，避免立即关闭
        settingsPanel.classList.toggle('open');
        if (historyPanel.classList.contains('open')) {
          historyPanel.classList.remove('open');
        }
      });
    }

    // --- 设置历史面板及其控制 ---
    function setupHistoryPanel() {
      // 浮动按钮
      historyToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到 document，避免立即关闭
        historyPanel.classList.toggle('open');
        if (settingsPanel.classList.contains('open')) {
          settingsPanel.classList.remove('open');
        }
      });
      // 头部按钮
      headerHistoryToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到 document，避免立即关闭
        historyPanel.classList.toggle('open');
        if (settingsPanel.classList.contains('open')) {
          settingsPanel.classList.remove('open');
        }
      });

      // 画面变换控制
      rotate90Btn.addEventListener('click', () => {
        transformSettings.rotate = (transformSettings.rotate + 90) % 360;
        applyVideoTransformations();
        saveAllSettings();
      });

      flipXBtn.addEventListener('click', () => {
        transformSettings.scaleX *= -1;
        applyVideoTransformations();
        saveAllSettings();
      });

      flipYBtn.addEventListener('click', () => {
        transformSettings.scaleY *= -1;
        applyVideoTransformations();
        saveAllSettings();
      });

      zoomSlider.addEventListener('input', () => {
        transformSettings.zoom = parseInt(zoomSlider.value);
        zoomValueSpan.textContent = `${transformSettings.zoom}%`;
        applyVideoTransformations();
        saveAllSettings();
      });

      resetTransformBtn.addEventListener('click', () => {
        transformSettings.rotate = 0;
        transformSettings.scaleX = 1;
        transformSettings.scaleY = 1;
        transformSettings.zoom = 100;
        zoomSlider.value = 100;
        zoomValueSpan.textContent = '100%';
        applyVideoTransformations();
        saveAllSettings();
      });

      // 视频滤镜控制
      brightnessSlider.addEventListener('input', () => {
        filterSettings.brightness = parseInt(brightnessSlider.value);
        brightnessValueSpan.textContent = `${filterSettings.brightness}%`;
        clearActiveFilterPreset();
        applyVideoFilters();
        saveAllSettings();
      });

      contrastSlider.addEventListener('input', () => {
        filterSettings.contrast = parseInt(contrastSlider.value);
        contrastValueSpan.textContent = `${filterSettings.contrast}%`;
        clearActiveFilterPreset();
        applyVideoFilters();
        saveAllSettings();
      });

      saturationSlider.addEventListener('input', () => {
        filterSettings.saturation = parseInt(saturationSlider.value);
        saturationValueSpan.textContent = `${filterSettings.saturation}%`;
        clearActiveFilterPreset();
        applyVideoFilters();
        saveAllSettings();
      });

      sharpenSlider.addEventListener('input', () => {
        filterSettings.sharpen = parseInt(sharpenSlider.value);
        sharpenValueSpan.textContent = `${filterSettings.sharpen}`;
        clearActiveFilterPreset();
        applyVideoFilters();
        saveAllSettings();
      });

      resetFilterBtn.addEventListener('click', () => {
        filterSettings.brightness = 100;
        filterSettings.contrast = 100;
        filterSettings.saturation = 100;
        filterSettings.sharpen = 0;
        updateFilterSlidersUI();
        clearActiveFilterPreset();
        applyVideoFilters();
        saveAllSettings();
      });

      filterPresetsContainer.addEventListener('click', (e) => {
        const targetBtn = e.target.closest('.preset-btn');
        if (targetBtn && targetBtn.dataset.preset) {
          const preset = filterPresets[targetBtn.dataset.preset];
          if (preset) {
            filterSettings.brightness = preset.brightness;
            filterSettings.contrast = preset.contrast;
            filterSettings.saturation = preset.saturation;
            filterSettings.sharpen = preset.sharpen; // 预设不包含锐化，这里会重置为0
            updateFilterSlidersUI();
            clearActiveFilterPreset();
            targetBtn.classList.add('active-preset');
            applyVideoFilters();
            saveAllSettings();
          }
        }
      });
    }

    // --- 应用视频画面变换 ---
    function applyVideoTransformations() {
      if (!videoPlayer) return;
      videoPlayer.style.transform = `rotate(${transformSettings.rotate}deg) scaleX(${transformSettings.scaleX}) scaleY(${transformSettings.scaleY}) scale(${transformSettings.zoom / 100})`;
    }

    // --- 应用视频滤镜 ---
    function applyVideoFilters() {
      if (!videoPlayer) return;
      let filterStyle = `brightness(${filterSettings.brightness}%) contrast(${filterSettings.contrast}%) saturate(${filterSettings.saturation}%)`;
      if (filterSettings.sharpen > 0 && filterSettings.sharpen <= 10) {
        filterStyle += ` url(#sharpen-filter-${filterSettings.sharpen})`;
      }
      videoPlayer.style.filter = filterStyle;
    }

    // --- 更新滤镜滑块UI ---
    function updateFilterSlidersUI() {
      brightnessSlider.value = filterSettings.brightness;
      brightnessValueSpan.textContent = `${filterSettings.brightness}%`;
      contrastSlider.value = filterSettings.contrast;
      contrastValueSpan.textContent = `${filterSettings.contrast}%`;
      saturationSlider.value = filterSettings.saturation;
      saturationValueSpan.textContent = `${filterSettings.saturation}%`;
      sharpenSlider.value = filterSettings.sharpen;
      sharpenValueSpan.textContent = `${filterSettings.sharpen}`;
    }

    // --- 清除激活的滤镜预设按钮样式 ---
    function clearActiveFilterPreset() {
      document.querySelectorAll('#filterPresetsContainer .preset-btn').forEach(btn => btn.classList.remove('active-preset'));
    }

    // --- 获取锐化矩阵值 ---
    function getSharpenMatrix(level) {
      if (level === 0) return '';
      // 锐化矩阵的中心值和边缘值会根据 level 变化
      // 这里使用一个简单的线性插值来模拟不同强度的锐化效果
      const baseK = 5; // 基础中心值
      const maxKBoost = 8; // 中心值最大增量
      const edgeBase = -0.5; // 基础边缘值
      const maxEdgeBoost = -1.0; // 边缘值最大减量 (负值)

      const kValue = baseK + (maxKBoost * (level - 1) / 9); // 中心值
      const eValue = edgeBase + (maxEdgeBoost * (level - 1) / 9); // 边缘值

      const k = kValue.toFixed(2);
      const e = eValue.toFixed(2);

      // 3x3 锐化卷积核
      return `${e} ${e} ${e} ${e} ${k} ${e} ${e} ${e} ${e}`;
    }

    // --- 创建锐化滤镜的 SVG 元素 ---
    function createSharpenSVGElements() {
      // 注意：这里是 XML 命名空间，必须是 http://www.w3.org/2000/svg
      const svgNS = "http://www.w3.org/2000/svg";
      let svgContainer = document.getElementById('sharpen-svg-filters');

      // 清空现有滤镜，防止重复添加
      svgContainer.innerHTML = '';

      for (let i = 1; i <= 10; i++) { // 从 1 到 10 级锐化
        const filterId = `sharpen-filter-${i}`;
        const matrixValue = getSharpenMatrix(i);

        const filterElement = document.createElementNS(svgNS, 'filter');
        filterElement.setAttribute('id', filterId);

        const convolveMatrix = document.createElementNS(svgNS, 'feConvolveMatrix');
        convolveMatrix.setAttribute('order', '3'); // 3x3 矩阵
        convolveMatrix.setAttribute('kernelMatrix', matrixValue);
        // convolveMatrix.setAttribute('divisor', '1'); // 默认除数，通常用于归一化，锐化中可能不需要
        // convolveMatrix.setAttribute('bias', '0'); // 默认偏差

        filterElement.appendChild(convolveMatrix);
        svgContainer.appendChild(filterElement);
      }
    }

    // --- 设置拖放区域功能 ---
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('uploadPlaceholder');
      const fileInput = document.getElementById('fileInput');

      // 阻止默认的拖放行为
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        document.body.addEventListener(eventName, preventDefaults, false); // 全局阻止
        uploadArea.addEventListener(eventName, preventDefaults, false); // 针对上传区域阻止
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // 拖入/拖出时的样式变化
      ['dragenter', 'dragover'].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          () => {
            uploadArea.classList.add('drag-over');
          },
          false
        );
      });

      ['dragleave', 'drop'].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          () => {
            uploadArea.classList.remove('drag-over');
          },
          false
        );
      });

      // 处理文件拖放
      uploadArea.addEventListener(
        'drop',
        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files && files.length) {
            const file = files[0];
            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.srt') || fileName.endsWith('.vtt')) {
              // 处理字幕文件
              const reader = new FileReader();
              reader.onload = function (event) {
                parseAndActivateSubtitle(event.target.result);
                currentSubtitleFileName = file.name;
                updateSubtitleSelectLabel(file.name);
                // 弹窗已移除
              };
              reader.readAsText(file);
            } else if (file.type.startsWith('video/')) {
              // 处理视频文件
              playLocalVideo(file);
            } else {
              alert('不支持的文件类型。请拖放视频或字幕文件 (.srt, .vtt)。');
            }
          }
        },
        false
      );
    }

    // --- 设置播放器事件监听 ---
    function setupPlayerEvents() {
      videoPlayer.addEventListener('timeupdate', function () {
        if (!isSeeking) { // 只有当用户没有拖动进度条时，才更新滑块位置
          seekSlider.value = videoPlayer.currentTime;
        }
        currentTimeDisplay.textContent = formatTime(videoPlayer.currentTime);

        // 更新自定义字幕显示
        if (subtitleActive && currentSubtitleTracks.length > 0) {
          updateSubtitleDisplay(this.currentTime);
        } else {
          // 如果没有激活自定义字幕或没有字幕数据，确保自定义字幕显示区域隐藏
          subtitleDisplay.textContent = '';
          subtitleDisplay.style.display = 'none';
        }
      });

      videoPlayer.addEventListener('loadedmetadata', function() {
        seekSlider.max = videoPlayer.duration;
        durationDisplay.textContent = formatTime(videoPlayer.duration);
        currentTimeDisplay.textContent = formatTime(videoPlayer.currentTime); // 确保初始显示00:00
      });

      videoPlayer.addEventListener('play', function () {
        updateStatus('playing', '正在播放');
        // 更新播放/暂停按钮状态
        playPauseIcon.className = 'fas fa-pause';
        playPauseText.textContent = '暂停';
        // 隐藏占位符，显示视频容器
        uploadPlaceholder.classList.add('hidden');
        videoContainerElement.classList.add('visible');
      });

      videoPlayer.addEventListener('pause', function () {
        updateStatus('stopped', '播放已暂停');
        // 更新播放/暂停按钮状态
        playPauseIcon.className = 'fas fa-play';
        playPauseText.textContent = '播放';
      });

      videoPlayer.addEventListener('waiting', function () {
        updateStatus('loading', '正在缓冲...');
      });

      videoPlayer.addEventListener('ended', function () {
        updateStatus('stopped', '播放已结束');
        seekSlider.value = videoPlayer.duration; // 播放结束后将进度条停在末尾
        currentTimeDisplay.textContent = formatTime(videoPlayer.duration);
        // 播放结束，重置播放/暂停按钮状态
        playPauseIcon.className = 'fas fa-play';
        playPauseText.textContent = '播放';
        currentVideoIsLocal = false; // 确保本地视频标记重置
        // 视频播放结束，停留在最后一帧，不重新显示占位符
        // uploadPlaceholder.classList.remove('hidden'); // REMOVED
        // videoContainerElement.classList.remove('visible'); // REMOVED
      });

      videoPlayer.addEventListener('error', function () {
        const error = this.error;
        let errorMessage = '未知错误';
        if (error) {
          switch (error.code) {
            case error.MEDIA_ERR_ABORTED:
              errorMessage = '用户终止了播放。';
              break;
            case error.MEDIA_ERR_NETWORK:
              errorMessage = '网络错误导致视频下载失败。';
              break;
            case error.MEDIA_ERR_DECODE:
              errorMessage = '视频解码错误。';
              break;
            case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
              errorMessage = '视频源格式不受支持或文件损坏。';
              break;
            default:
              errorMessage = `错误代码: ${error.code} - ${error.message}`;
              break;
          }
        }
        console.error('播放错误:', error);
        updateStatus('stopped', '播放错误: ' + errorMessage);
        // 播放错误，重置播放/暂停按钮状态
        playPauseIcon.className = 'fas fa-play';
        playPauseText.textContent = '播放';
        currentVideoIsLocal = false; // 确保本地视频标记重置
        // 视频播放错误，重新显示占位符
        uploadPlaceholder.classList.remove('hidden');
        videoContainerElement.classList.remove('visible');
      });

      // 进度条拖动事件
      seekSlider.addEventListener('mousedown', () => {
        isSeeking = true;
        videoPlayer.pause(); // 拖动时暂停视频，提供更流畅的拖动体验
      });

      seekSlider.addEventListener('mouseup', () => {
        isSeeking = false;
        videoPlayer.currentTime = seekSlider.value; // 设置视频当前时间为滑块值
        videoPlayer.play(); // 恢复播放
      });

      seekSlider.addEventListener('input', () => {
        // 用户拖动滑块时，实时更新当前时间显示
        currentTimeDisplay.textContent = formatTime(seekSlider.value);
      });
    }

    // --- 将秒数格式化为 HH:MM:SS 或 MM:SS 格式 ---
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = Math.floor(minutes % 60);

      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      }
    }

    // --- 设置音量控制 ---
    function setupVolumeControl() {
      // 初始化音量
      videoPlayer.volume = volumeSlider.value / 100;
      volumePercentage.textContent = volumeSlider.value + '%';
      updateMuteButtonIcon(); // 确保静音按钮图标与初始音量状态一致

      // 音量滑块事件
      volumeSlider.addEventListener('input', function () {
        const volume = this.value / 100;
        videoPlayer.volume = volume;
        volumePercentage.textContent = this.value + '%';

        // 更新音量图标 (滑块旁的图标)
        if (volume === 0) {
          volumeIcon.className = 'fas fa-volume-mute';
        } else if (volume < 0.5) {
          volumeIcon.className = 'fas fa-volume-down';
        } else {
          volumeIcon.className = 'fas fa-volume-up';
        }
        updateMuteButtonIcon(); // 音量变化时更新静音按钮图标
      });
    }

    // --- 设置字幕样式控制 ---
    function setupSubtitleSettings() {
      // 初始化设置
      subtitleSizeSlider.value = currentSubtitleSettings.fontSize;
      subtitleSizeValue.value = currentSubtitleSettings.fontSize;
      subtitleColorPicker.value = currentSubtitleSettings.color;
      applySubtitleSettings();

      // 监听大小滑块
      subtitleSizeSlider.addEventListener('input', function () {
        subtitleSizeValue.value = this.value;
        currentSubtitleSettings.fontSize = parseInt(this.value);
        applySubtitleSettings();
        saveAllSettings();
      });

      // 监听大小输入框
      subtitleSizeValue.addEventListener('change', function () {
        let val = parseInt(this.value);
        if (isNaN(val) || val < parseInt(subtitleSizeSlider.min) || val > parseInt(subtitleSizeSlider.max)) {
          val = defaultSubtitleSettings.fontSize;
          // 恢复默认或上次有效值
          this.value = val;
        }
        subtitleSizeSlider.value = val;
        currentSubtitleSettings.fontSize = val;
        applySubtitleSettings();
        saveAllSettings();
      });

      // 监听颜色选择器
      subtitleColorPicker.addEventListener('input', function () {
        currentSubtitleSettings.color = this.value;
        applySubtitleSettings();
        saveAllSettings();
      });
    }

    // --- 应用字幕样式 ---
    function applySubtitleSettings() {
      subtitleDisplay.style.fontSize = `${currentSubtitleSettings.fontSize}px`;
      subtitleDisplay.style.color = currentSubtitleSettings.color;
    }

    // --- 保存所有设置到 localStorage ---
    function saveAllSettings() {
      const settings = {
        subtitle: currentSubtitleSettings,
        transform: transformSettings,
        filter: filterSettings,
        playbackRate: videoPlayer.playbackRate || 1.0,
      };
      localStorage.setItem('playerSettings', JSON.stringify(settings));
    }

    // --- 从 localStorage 加载所有设置 ---
    function loadAllSettings() {
      const saved = localStorage.getItem('playerSettings');
      if (saved) {
        const s = JSON.parse(saved);

        // 加载字幕设置
        if (s.subtitle) {
          Object.assign(currentSubtitleSettings, s.subtitle);
          setupSubtitleSettings(); // 重新应用字幕设置
        }

        // 加载画面变换设置
        if (s.transform) {
          Object.assign(transformSettings, s.transform);
          zoomSlider.value = transformSettings.zoom;
          zoomValueSpan.textContent = `${transformSettings.zoom}%`;
          applyVideoTransformations();
        }

        // 加载滤镜设置
        if (s.filter) {
          Object.assign(filterSettings, s.filter);
          updateFilterSlidersUI();
          applyVideoFilters();
          // 检查是否与预设匹配，并激活相应按钮
          let matchedPreset = false;
          for (const presetKey in filterPresets) {
            const p = filterPresets[presetKey];
            if (p.brightness === filterSettings.brightness &&
                p.contrast === filterSettings.contrast &&
                p.saturation === filterSettings.saturation &&
                p.sharpen === filterSettings.sharpen) { // 包含锐化检查
              const presetButton = document.querySelector(`#filterPresetsContainer .preset-btn[data-preset="${presetKey}"]`);
              if (presetButton) presetButton.classList.add('active-preset');
              matchedPreset = true;
              break;
            }
          }
          if (!matchedPreset) clearActiveFilterPreset();
        }

        // 加载播放速度
        if (s.playbackRate) {
          changeSpeed(s.playbackRate, document.querySelector(`#speedBtnGroup .btn[data-speed="${s.playbackRate}"]`));
        } else {
          changeSpeed(1.0, document.querySelector(`#speedBtnGroup .btn[data-speed="1"]`));
        }
      } else {
        // 如果没有保存的设置，应用默认值
        resetTransformBtn.click(); // 重置画面
        resetFilterBtn.click(); // 重置滤镜
        changeSpeed(1.0, document.querySelector(`#speedBtnGroup .btn[data-speed="1"]`)); // 默认速度
      }
    }

    // --- 更新播放状态 ---
    function updateStatus(status, message) {
      const indicator = document.getElementById('statusIndicator');
      indicator.className = `status-indicator ${status}`;
      indicator.innerHTML = `<i class="fas fa-circle"></i> ${message}`;
    }

    // --- 播放/暂停按钮的点击处理 ---
    function handlePlayPause() {
      const inputUrl = document.getElementById('videoURL').value.trim();

      // 如果输入框显示的是本地文件信息
      if (inputUrl.startsWith('本地文件:')) {
          if (currentLocalFileObject) {
              // 如果有存储的本地文件对象，则切换播放/暂停状态
              if (videoPlayer.paused) {
                  videoPlayer.play();
              } else {
                  videoPlayer.pause();
              }
          } else {
              // 本地文件信息在输入框中，但文件对象已丢失（例如页面刷新后）
              // 停止当前播放并显示占位符
              stopPlaybackInternal(false); 
          }
      }
      // 如果输入框中存在一个与当前播放视频不同的新网络URL，加载并播放它。
      else if (inputUrl && inputUrl !== currentVideoUrl) {
          play(inputUrl);
      }
      // 如果没有新URL，或者URL与当前播放视频相同，且有视频已加载（播放或暂停中），
      // 则切换当前视频的播放/暂停状态。
      else if (videoPlayer.src) { // 检查 videoPlayer 是否有源已加载
          if (videoPlayer.paused) {
              videoPlayer.play();
          } else {
              videoPlayer.pause();
          }
      } else {
          // 输入框为空，且没有视频加载。提示用户。
          alert('请输入视频URL或点击“上传本地视频”！');
      }
    }

    // --- 重新加载视频按钮的点击处理 ---
    function reloadVideo() {
        const inputUrl = document.getElementById('videoURL').value.trim();

        if (inputUrl.startsWith('本地文件:')) {
            // 如果输入框显示的是本地文件，尝试重新播放存储的 File 对象
            if (currentLocalFileObject) {
                // 重新播放存储的文件
                playLocalVideo(currentLocalFileObject);
            } else {
                // 本地文件信息在输入框中，但文件对象已丢失
                // 停止当前播放并显示占位符
                stopPlaybackInternal(false); 
            }
        } else if (inputUrl) {
            // 如果输入框中有网络URL，强制重新加载并播放它。
            play(inputUrl);
        } else {
            // 输入框为空，且没有本地文件在播放。
            alert('请输入视频URL或点击“上传本地视频”按钮选择文件以重新加载。');
        }
    }

    // --- 播放本地视频 ---
    function playLocalVideo(file) {
      // 检查文件格式
      const extension = file.name.split('.').pop().toLowerCase();

      if (!supportedFormats.includes(extension)) {
        alert(`不支持的视频格式: .${extension}\n请尝试其他视频文件，或确保文件未损坏。`);
        updateStatus('stopped', `不支持的格式: .${extension}`);
        return;
      }

      // 撤销之前可能的 blob URL，防止内存泄漏
      if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
        URL.revokeObjectURL(videoPlayer.src);
      }

      currentLocalFileObject = file; // 存储 File 对象
      currentLocalFileName = file.name; // 存储文件名
      const fileURL = URL.createObjectURL(file);

      // 更新输入框显示本地文件名称
      document.getElementById('videoURL').value = `本地文件: ${file.name}`;

      // 停止之前的播放并清理 (保持占位符隐藏)
      stopPlaybackInternal(true);

      currentVideoIsLocal = true; // 标记为本地视频
      currentVideoUrl = fileURL; // 存储 blob URL

      // 播放新视频
      play(fileURL);

      // 添加到历史记录 (显示文件名为标题)
      addToHistory(`本地文件: ${file.name}`, fileURL, file.name);

      updateStatus('playing', `正在播放: ${file.name}`);
    }

    /**
     * 自动检测并播放视频
     * @param {string} url - 视频地址
     */
    function play(url) {
      // 停止之前的播放并清理 (保持占位符隐藏)
      stopPlaybackInternal(true);

      currentVideoUrl = url; // 更新当前播放的URL
      currentVideoIsLocal = url.startsWith('blob:'); // 再次确认是否为本地文件

      updateStatus('loading', '正在加载视频...'); // 立即显示加载状态，提供即时反馈

      // 隐藏占位符，显示视频容器
      uploadPlaceholder.classList.add('hidden');
      videoContainerElement.classList.add('visible');

      // 应用画面变换和滤镜
      applyVideoTransformations();
      applyVideoFilters();

      if (url.startsWith('blob:')) {
        // 本地文件 (Blob URL)
        videoPlayer.src = url;
        videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
        videoPlayer.play().catch((e) => {
          console.error('本地视频播放错误:', e);
          updateStatus('stopped', '播放错误: ' + e.message);
          // 播放失败，重新显示占位符
          uploadPlaceholder.classList.remove('hidden');
          videoContainerElement.classList.remove('visible');
        });
        return;
      }

      if (url.indexOf('rtmp://') === 0) {
        alert('当前浏览器不支持 RTMP 协议播放，请尝试其他视频格式！');
        updateStatus('stopped', '不支持RTMP协议');
        // 播放失败，重新显示占位符
        uploadPlaceholder.classList.remove('hidden');
        videoContainerElement.classList.remove('visible');
        return;
      }

      // 获取文件扩展名
      const extension = getFileExtension(url);

      // 判断是否为 HLS（m3u8 格式）
      if (extension === 'm3u8' || url.includes('.m3u8?')) {
        if (Hls.isSupported()) {
          hlsInstance = new Hls();
          hlsInstance.loadSource(url);
          hlsInstance.attachMedia(videoPlayer);
          hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () {
            videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
            videoPlayer
              .play()
              .then(() => updateStatus('playing', '正在播放'))
              .catch((e) => {
                console.error('HLS播放错误:', e);
                updateStatus('stopped', '播放错误: ' + e.message);
                // 播放失败，重新显示占位符
                uploadPlaceholder.classList.remove('hidden');
                videoContainerElement.classList.remove('visible');
              });
          });
          hlsInstance.on(Hls.Events.ERROR, function (event, data) {
            console.error('HLS错误:', data);
            updateStatus('stopped', 'HLS错误: ' + data.details);
            // 播放失败，重新显示占位符
            uploadPlaceholder.classList.remove('hidden');
            videoContainerElement.classList.remove('visible');
          });
        } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari 浏览器原生支持 HLS
          videoPlayer.src = url;
          videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
          videoPlayer
            .play()
            .then(() => updateStatus('playing', '正在播放'))
            .catch((e) => {
              console.error('原生HLS播放错误:', e);
              updateStatus('stopped', '播放错误: ' + e.message);
              // 播放失败，重新显示占位符
              uploadPlaceholder.classList.remove('hidden');
              videoContainerElement.classList.remove('visible');
            });
        } else {
          alert('当前浏览器不支持 HLS 视频播放！');
          updateStatus('stopped', '不支持HLS播放');
          // 播放失败，重新显示占位符
          uploadPlaceholder.classList.remove('hidden');
          videoContainerElement.classList.remove('visible');
          return;
        }
      }
      // 判断是否为 FLV 格式
      else if (extension === 'flv' || url.includes('.flv?')) {
        if (flvjs.isSupported()) {
          flvPlayer = flvjs.createPlayer({
            type: 'flv',
            url: url,
          });
          flvPlayer.attachMediaElement(videoPlayer);
          flvPlayer.load();
          videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
          flvPlayer
            .play()
            .then(() => updateStatus('playing', '正在播放'))
            .catch((e) => {
              console.error('FLV播放错误:', e);
              updateStatus('stopped', '播放错误: ' + e.message);
              // 播放失败，重新显示占位符
              uploadPlaceholder.classList.remove('hidden');
              videoContainerElement.classList.remove('visible');
            });
        } else {
          alert('当前浏览器不支持 FLV 视频播放！');
          updateStatus('stopped', '不支持FLV播放');
          // 播放失败，重新显示占位符
          uploadPlaceholder.classList.remove('hidden');
          videoContainerElement.classList.remove('visible');
          return;
        }
      }
      // 其他格式（尝试浏览器原生支持）
      else {
        videoPlayer.src = url;
        videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
        videoPlayer
          .play()
          .then(() => updateStatus('playing', '正在播放'))
          .catch((e) => {
            console.error('原生播放错误:', e);
            updateStatus('stopped', '播放失败，尝试其他方式...');

            // 如果原生播放失败，尝试使用HLS.js (有时非标准MP4等也可以被HLS.js处理)
            if (Hls.isSupported()) {
              updateStatus('loading', '尝试使用HLS播放...');
              hlsInstance = new Hls();
              hlsInstance.loadSource(url);
              hlsInstance.attachMedia(videoPlayer);
              hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () {
                videoPlayer.currentTime = 0.01; // 尝试强制渲染第一帧
                videoPlayer
                  .play()
                  .then(() => updateStatus('playing', '正在播放'))
                  .catch((e) => {
                    console.error('HLS回退播放错误:', e);
                    updateStatus('stopped', '播放失败');
                    // 播放失败，重新显示占位符
                    uploadPlaceholder.classList.remove('hidden');
                    videoContainerElement.classList.remove('visible');
                  });
              });
              hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                console.error('HLS回退错误:', data);
                updateStatus('stopped', 'HLS回退错误: ' + data.details);
                // 播放失败，重新显示占位符
                uploadPlaceholder.classList.remove('hidden');
                videoContainerElement.classList.remove('visible');
              });
            } else {
              updateStatus('stopped', '播放失败，浏览器不支持此格式。');
              // 播放失败，重新显示占位符
              uploadPlaceholder.classList.remove('hidden');
              videoContainerElement.classList.remove('visible');
            }
          });
      }
      // 添加到历史记录 (只有网络URL才添加到历史记录，本地视频已在 playLocalVideo 中添加)
      if (!currentVideoIsLocal) {
        addToHistory(url, url, null); // 初始标题就是URL本身
      }
    }

    // --- 停止播放内部实现 ---
    function stopPlaybackInternal(keepPlaceholderHidden = false) {
      videoPlayer.pause();
      // 如果是本地视频，撤销 Blob URL (但保留 currentLocalFileObject)
      if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
        URL.revokeObjectURL(videoPlayer.src);
      }
      videoPlayer.removeAttribute('src'); // 移除视频源
      videoPlayer.load(); // 重新加载媒体元素以清除状态

      videoPlayer.currentTime = 0;
      seekSlider.value = 0; // 停止时进度条归零
      currentTimeDisplay.textContent = '00:00'; // 停止时时间显示归零
      durationDisplay.textContent = '00:00'; // 停止时时长显示归零

      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
      if (flvPlayer) {
        flvPlayer.destroy();
        flvPlayer = null;
      }
      // 不清除 currentLocalFileObject，以便可以重新加载本地文件

      currentVideoIsLocal = false; // 清除本地视频标记
      currentVideoUrl = null; // 清除当前播放URL

      // 清理字幕
      removeSubtitle();

      updateStatus('stopped', '播放器已停止');

      // 根据参数决定是否显示占位符
      if (!keepPlaceholderHidden) {
        uploadPlaceholder.classList.remove('hidden');
        videoContainerElement.classList.remove('visible');
        // 如果停止播放，且不是本地文件，清空输入框
        if (!document.getElementById('videoURL').value.startsWith('本地文件:')) {
            document.getElementById('videoURL').value = '';
        }
      }

      // 重置播放/暂停按钮状态
      playPauseIcon.className = 'fas fa-play';
      playPauseText.textContent = '播放';
    }

    // --- 停止播放 (外部接口) ---
    function stopPlayback() {
      stopPlaybackInternal(false); // 停止并显示占位符
      currentLocalFileObject = null; // 外部停止时，清除本地文件对象
      currentLocalFileName = null; // 清除文件名
      document.getElementById('videoURL').value = ''; // 外部停止时，清空输入框
    }

    // --- 获取文件扩展名 ---
    function getFileExtension(url) {
      // 确保能正确处理带查询参数或哈希的URL
      const parts = url.split('.');
      if (parts.length > 1) {
        return parts.pop().split(/[#?]/)[0].toLowerCase();
      }
      return ''; // 没有扩展名
    }

    // --- Helper: 将时间字符串 (HH:MM:SS,ms 或 HH:MM:SS.ms) 转换为秒数 ---
    function parseTime(timeStr) {
      const parts = timeStr.split(':');
      const secondsAndMs = parts[parts.length - 1].split(/[,.]/); // 处理 00:00.000 或 00:00:00.000 格式
      let hours = 0, minutes = 0, seconds = 0, milliseconds = 0;

      if (parts.length === 3) { // HH:MM:SS
          hours = parseInt(parts[0], 10);
          minutes = parseInt(parts[1], 10);
          seconds = parseInt(secondsAndMs[0], 10);
          milliseconds = parseInt(secondsAndMs[1], 10) || 0;
      } else if (parts.length === 2) { // MM:SS
          minutes = parseInt(parts[0], 10);
          seconds = parseInt(secondsAndMs[0], 10);
          milliseconds = parseInt(secondsAndMs[1], 10) || 0;
      }
      return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
    }

    // --- 解析 SRT 或 VTT 内容为字幕对象数组 ---
    function parseSrtOrVtt(content) {
      const subtitles = [];
      const lines = content.split(/\r?\n/); // 兼容不同换行符
      let i = 0;
      while (i < lines.length) {
        // 跳过空行或非字幕行，直到找到数字或 WEBVTT/NOTE/STYLE
        if (!lines[i].trim() || (isNaN(parseInt(lines[i].trim(), 10)) && !lines[i].trim().toUpperCase().startsWith('WEBVTT') && !lines[i].trim().startsWith('NOTE') && !lines[i].trim().startsWith('STYLE') && !lines[i].trim().includes('-->'))) {
          i++;
          continue;
        }

        if (lines[i].trim().toUpperCase() === 'WEBVTT') {
          i++; // 跳过 WEBVTT 头部
          while (i < lines.length && lines[i].trim() === '') i++; // 跳过头部后的空行
          continue;
        }
        if (lines[i].trim().startsWith('NOTE') || lines[i].trim().startsWith('STYLE')) {
          i++; // 跳过注释/样式
          while (i < lines.length && lines[i].trim() !== '') i++; // 跳过注释/样式内容
          while (i < lines.length && lines[i].trim() === '') i++; // 跳过注释/样式后的空行
          continue;
        }

        // 潜在的字幕编号或时间行
        let cueId = '';
        if (!isNaN(parseInt(lines[i].trim(), 10))) {
          cueId = lines[i].trim(); // 字幕编号，不严格需要用于显示
          i++;
          while (i < lines.length && lines[i].trim() === '') i++; // 跳过编号后的空行
        }

        let timeLine = '';
        if (i < lines.length && lines[i].includes('-->')) {
          timeLine = lines[i].trim();
          i++;
        } else {
          // 如果没有时间行，则不是有效的字幕，跳到下一行
          i++;
          continue;
        }

        let textLines = [];
        while (i < lines.length && lines[i].trim() !== '') {
          textLines.push(lines[i].trim());
          i++;
        }

        const timeParts = timeLine.split(' --> ');
        if (timeParts.length === 2) {
          const start = parseTime(timeParts[0]);
          const end = parseTime(timeParts[1]);
          const text = textLines.join('\n');
          subtitles.push({ start, end, text });
        }
      }
      return subtitles;
    }

    // --- 上传字幕文件并加载 ---
    function uploadSubtitleFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.vtt,.srt';
      input.style.display = 'none';

      input.onchange = function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const content = event.target.result;
          parseAndActivateSubtitle(content);
          currentSubtitleFileName = file.name;
          updateSubtitleSelectLabel(file.name);
          // 弹窗已移除
        };
        reader.readAsText(file);
      };

      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }

    // --- 更新字幕选择下拉显示文本（显示文件名，且禁用“上传字幕文件”选项） ---
    function updateSubtitleSelectLabel(fileName) {
      const subtitleSelect = document.getElementById('subtitleSelect');
      // 清空所有选项
      subtitleSelect.innerHTML = '';

      // 添加“无字幕”选项
      const noneOption = document.createElement('option');
      noneOption.value = 'none';
      noneOption.textContent = '无字幕';
      subtitleSelect.appendChild(noneOption);

      // 添加上传的字幕文件名作为唯一选项（选中）
      if (fileName) {
        const fileOption = document.createElement('option');
        fileOption.value = 'uploaded';
        fileOption.textContent = fileName;
        fileOption.selected = true;
        subtitleSelect.appendChild(fileOption);
      } else {
        noneOption.selected = true;
      }
    }

    // --- 解析并激活自定义字幕 ---
    function parseAndActivateSubtitle(content) {
      currentSubtitleTracks = parseSrtOrVtt(content);
      subtitleActive = true;
      subtitleDisplay.style.display = 'block';
      subtitleDisplay.textContent = ''; // 清空旧内容
      updateSubtitleDisplay(videoPlayer.currentTime);
      applySubtitleSettings();
      updateToggleSubtitleButtonIcon(); // 字幕加载成功，更新图标为“显示”状态
    }

    // --- 根据当前播放时间更新自定义字幕显示 ---
    function updateSubtitleDisplay(currentTime) {
      let currentCaption = '';

      for (const track of currentSubtitleTracks) {
        if (currentTime >= track.start && currentTime <= track.end) {
          currentCaption = track.text;
          break;
        }
      }
      subtitleDisplay.innerHTML = currentCaption.replace(/\n/g, '<br>'); // 支持多行字幕
      subtitleDisplay.style.display = currentCaption ? 'block' : 'none';
    }

    // --- 切换字幕显示（仅针对自定义字幕） ---
    function toggleSubtitle() {
      if (currentSubtitleTracks.length === 0) {
        alert('没有加载外挂字幕文件。请先上传字幕文件。');
        subtitleActive = false; // 确保状态为未激活
        updateToggleSubtitleButtonIcon(); // 确保图标为“隐藏”状态
        subtitleDisplay.style.display = 'none';
        return;
      }

      subtitleActive = !subtitleActive; // 切换状态

      if (subtitleActive) {
        updateSubtitleDisplay(videoPlayer.currentTime);
        subtitleDisplay.style.display = 'block';
      } else {
        subtitleDisplay.style.display = 'none';
      }
      updateToggleSubtitleButtonIcon(); // 更新图标
    }

    // --- 更新显示/隐藏字幕按钮的图标 ---
    function updateToggleSubtitleButtonIcon() {
      const toggleBtn = document.getElementById('toggleSubtitleBtn');
      if (toggleBtn) {
        const toggleIcon = toggleBtn.querySelector('i');
        if (toggleIcon) {
          if (subtitleActive) { // 字幕当前是激活（显示）状态
            toggleIcon.className = 'fas fa-eye'; // 图标显示正常眼睛，表示“当前可见”
          } else { // 字幕当前是未激活（隐藏）状态
            toggleIcon.className = 'fas fa-eye-slash'; // 图标显示带斜线眼睛，表示“当前隐藏”
          }
        }
      }
    }

    // --- 移除所有字幕（自定义） ---
    function removeSubtitle() {
      currentSubtitleTracks = [];
      subtitleActive = false;
      currentSubtitleFileName = null;
      subtitleDisplay.textContent = '';
      subtitleDisplay.style.display = 'none';

      // 确保原生文本轨道也被禁用，以防万一
      for (let i = 0; i < videoPlayer.textTracks.length; i++) {
        videoPlayer.textTracks[i].mode = 'disabled';
      }

      // 重置字幕选择框为“无字幕”
      updateSubtitleSelectLabel(null);
      updateToggleSubtitleButtonIcon(); // 字幕已移除，更新图标为“隐藏”状态
    }

    // --- Function to determine if a URL is likely a valid video URL ---
    function isValidVideoUrl(url) {
      // Check for common video file extensions
      const videoExtensions = ['mp4', 'm3u8', 'flv', 'webm', 'mkv', 'mov', 'avi', 'wmv', '3gp', 'ogg', 'mpg', 'mpeg', 'vob', 'ts']; // Added 'ts' for HLS segments
      const extension = getFileExtension(url);

      // Check if it's a blob URL (local file)
      if (url.startsWith('blob:')) {
        return true;
      }

      // Check if it has a known video extension
      if (videoExtensions.includes(extension)) {
        return true;
      }

      // Check for common streaming protocols/patterns (e.g., .m3u8 or .flv in path)
      if (url.includes('.m3u8') || url.includes('.flv')) {
        return true;
      }

      // Attempt to create a URL object to validate general URL format
      try {
        new URL(url);
        // If it's a valid URL, but doesn't have a known video extension or pattern,
        // we might still consider it valid if it's an online resource.
        // For the purpose of displaying a format tag, we only want to tag *known* video formats.
        // So, if it's a generic URL without video extension/pattern, don't tag it.
        return false; // If it's a generic URL without video extension/pattern, don't tag it.
      } catch (e) {
        return false; // Not a valid URL format
      }
    }

    // --- 添加到历史记录 ---
    function addToHistory(newTitle, newUrl, fileName) {
      // 避免添加重复的本地视频条目
      if (fileName) {
        // 检查历史记录中是否已有相同文件名的本地视频
        const exists = playbackHistory.some(item => 
          item.fileName === fileName && item.type === 'local'
        );
        
        if (exists) {
          return; // 如果已存在相同文件名的本地视频，不再添加
        }
      } else {
        // 对于在线视频，检查是否有相同URL和相同标题的条目
        const exists = playbackHistory.some(item => 
          item.url === newUrl && item.title === newTitle && item.type === 'remote'
        );
        if (exists) return;
      }

      // 添加新条目到历史记录的开头
      playbackHistory.unshift({
          title: newTitle, // 这是初始标题（URL或文件名），用户备注会修改它
          url: newUrl,
          fileName: fileName || null, // 存储文件名（仅限本地视频）
          type: fileName ? 'local' : 'remote', // 标记类型
          timestamp: new Date().toISOString(),
      });

      // 限制历史记录长度
      if (playbackHistory.length > 10) {
          playbackHistory.pop();
      }

      localStorage.setItem('playbackHistory', JSON.stringify(playbackHistory));
      renderHistory();
    }

    // --- Helper function to create event handlers for input ---
    function createInputHandlers(index) {
      const historyItem = document.getElementById(`historyItem_${index}`);
      const editInput = historyItem.querySelector('.history-title-edit');

      const blurHandler = (event) => {
        // 只有当当前编辑的索引匹配时才尝试保存，防止多个 blur 事件触发
        if (currentlyEditingIndex === index) {
            // 检查 blur 是否不是由点击保存按钮本身引起的
            // 这是一个常见的模式，以避免双重触发
            if (!event.relatedTarget || !event.relatedTarget.closest('.edit-save-btn')) {
                saveEditMode(index);
            }
        }
      };

      const keypressHandler = (event) => {
        if (event.key === 'Enter') {
          saveEditMode(index);
          event.preventDefault(); // 防止输入框在表单中时提交表单
        }
      };

      return { blurHandler, keypressHandler };
    }

    // --- 启动编辑模式 ---
    function startEditMode(index) {
      // 如果另一个项正在编辑，先保存它
      if (currentlyEditingIndex !== -1 && currentlyEditingIndex !== index) {
        saveEditMode(currentlyEditingIndex);
      }

      const historyItem = document.getElementById(`historyItem_${index}`);
      if (!historyItem) return;

      const displaySpan = historyItem.querySelector('.history-title-display');
      const editInput = historyItem.querySelector('.history-title-edit');
      const editSaveBtn = historyItem.querySelector('.edit-save-btn');
      const editSaveIcon = editSaveBtn.querySelector('i');
      const editSaveLabel = editSaveBtn.querySelector('.button-label');


      displaySpan.style.display = 'none';
      editInput.style.display = 'inline-block';
      editInput.value = displaySpan.textContent; // 将当前显示文本设置为输入框的值
      editInput.focus();
      editInput.select(); // 选中所有文本，方便用户编辑

      editSaveBtn.setAttribute('data-action', 'save');
      editSaveIcon.className = 'fas fa-check'; // 更改图标为对勾
      editSaveLabel.textContent = '保存'; // 更改标签文本为保存

      // 添加事件监听器用于保存
      const handlers = createInputHandlers(index);
      editInput.addEventListener('blur', handlers.blurHandler);
      editInput.addEventListener('keypress', handlers.keypressHandler);
      inputEventListeners.set(index, handlers); // 存储处理器引用

      currentlyEditingIndex = index;
    }

    // --- 保存编辑模式 ---
    function saveEditMode(index) {
      // 只有当该项是当前正在编辑的项时才执行保存
      if (currentlyEditingIndex !== index) return;

      const historyItem = document.getElementById(`historyItem_${index}`);
      if (!historyItem) return;

      const displaySpan = historyItem.querySelector('.history-title-display');
      const editInput = historyItem.querySelector('.history-title-edit');
      const editSaveBtn = historyItem.querySelector('.edit-save-btn');
      const editSaveIcon = editSaveBtn.querySelector('i');
      const editSaveLabel = editSaveBtn.querySelector('.button-label');

      const newTitle = editInput.value.trim();

      // 如果新标题为空，则恢复到历史记录中原有的标题
      if (newTitle === '') {
        editInput.value = playbackHistory[index].title; // 恢复输入框内容
      } else {
        // 更新历史记录数组
        playbackHistory[index].title = newTitle;
        localStorage.setItem('playbackHistory', JSON.stringify(playbackHistory));
      }
      displaySpan.textContent = playbackHistory[index].title; // 更新显示文本

      displaySpan.style.display = 'inline-block';
      editInput.style.display = 'none';

      editSaveBtn.setAttribute('data-action', 'edit');
      editSaveIcon.className = 'fas fa-edit'; // 更改图标回编辑
      editSaveLabel.textContent = '备注'; // 更改标签文本回备注

      // 移除事件监听器，避免重复绑定
      const handlers = inputEventListeners.get(index);
      if (handlers) {
        editInput.removeEventListener('blur', handlers.blurHandler);
        editInput.removeEventListener('keypress', handlers.keypressHandler);
        inputEventListeners.delete(index); // 从Map中移除
      }

      currentlyEditingIndex = -1; // 重置编辑状态
    }

    // --- 渲染历史记录 ---
    function renderHistory() {
      const historyList = document.getElementById('historyList');

      // 如果有项正在编辑，先保存它，因为DOM将被重新创建
      if (currentlyEditingIndex !== -1) {
        saveEditMode(currentlyEditingIndex);
      }

      // 清除所有旧的事件监听器引用和编辑状态，因为DOM元素将被替换
      inputEventListeners.clear();
      currentlyEditingIndex = -1;

      if (playbackHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-history">暂无播放历史</div>';
        return;
      }

      historyList.innerHTML = '';

      playbackHistory.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.id = `historyItem_${index}`; // 添加ID以便直接访问

        let formatTagHtml = '';
        if (isValidVideoUrl(item.url)) {
          let format = '未知';
          if (item.type === 'local') {
            format = '本地视频';
          } else {
            const ext = getFileExtension(item.url);
            if (ext) {
              format = ext.toUpperCase();
            } else if (item.url.includes('.m3u8')) {
              format = 'M3U8';
            } else if (item.url.includes('.flv')) {
              format = 'FLV';
            }
          }
          formatTagHtml = `<div class="format-tag">${format}</div>`;
        }

        historyItem.innerHTML = `
          <div class="title-wrapper">
            <span class="history-title-display">${item.title}</span>
            <input type="text" class="history-title-edit" value="${item.title}" style="display:none;" />
          </div>
          ${formatTagHtml}
          <div class="actions">
            <button class="play-btn" onclick="playFromHistory(${index})">
              <span class="button-label">播放</span>
              <i class="fas fa-play"></i>
            </button>
            <button class="edit-save-btn" data-index="${index}" data-action="edit">
              <span class="button-label">备注</span>
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn" onclick="removeHistoryItem(${index})">
              <span class="button-label">删除</span>
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        historyList.appendChild(historyItem);
      });
    }

    // --- 从历史记录播放 ---
    function playFromHistory(index) {
      const item = playbackHistory[index];
      if (!item) return;

      if (item.type === 'local') {
        // 如果是本地视频，尝试重新播放存储的 File 对象
        if (currentLocalFileObject && currentLocalFileName === item.fileName) {
            playLocalVideo(currentLocalFileObject);
            return;
        }
        // 如果文件对象不存在，提示用户重新上传
        alert('本地视频文件已丢失，请重新上传。');
        document.getElementById('videoURL').value = '';
        stopPlaybackInternal(false);
      } else {
        // 对于网络URL，正常播放
        document.getElementById('videoURL').value = item.url;
        play(item.url);
      }
    }

    // --- 删除历史记录项 ---
    function removeHistoryItem(index) {
      playbackHistory.splice(index, 1);
      localStorage.setItem('playbackHistory', JSON.stringify(playbackHistory));
      renderHistory(); // renderHistory会处理当前编辑项的保存和状态重置
    }

    // --- 清空历史记录 ---
    function clearHistory() {
      if (playbackHistory.length === 0) return;

      if (confirm('确定要清空所有播放历史吗？')) {
        playbackHistory = [];
        localStorage.removeItem('playbackHistory');
        renderHistory(); // renderHistory会处理当前编辑项的保存和状态重置
      }
    }

    // --- 切换全屏 ---
    function toggleFullscreen() {
      const videoContainer = document.getElementById('videoContainer'); // 使用容器进行全屏

      if (!document.fullscreenElement) {
        // 请求容器全屏，以便相关元素保持在一起
        if (videoContainer.requestFullscreen) {
          videoContainer.requestFullscreen();
        } else if (videoContainer.mozRequestFullScreen) { // Firefox
          videoContainer.mozRequestFullScreen();
        } else if (videoContainer.webkitRequestFullscreen) { // Chrome, Safari, Opera
          videoContainer.webkitRequestFullscreen();
        } else if (videoContainer.msRequestFullscreen) { // IE/Edge
          videoContainer.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) { // Firefox
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { // IE/Edge
          document.msExitFullscreen();
        }
      }
    }

    // --- 更改播放速度 ---
    function changeSpeed(speed, buttonElement) {
      videoPlayer.playbackRate = speed;
      // 移除所有速度按钮的激活样式
      document.querySelectorAll('#speedBtnGroup .btn').forEach(btn => btn.classList.remove('active-speed-btn'));
      // 为当前点击的按钮添加激活样式
      if (buttonElement) {
        buttonElement.classList.add('active-speed-btn');
      }
      // 仅在视频播放时更新状态文本
      if (!videoPlayer.paused) {
        updateStatus('playing', `正在播放 (${speed}x)`);
      }
      saveAllSettings(); // 保存播放速度设置
    }

    // --- 切换静音 ---
    function toggleMute() {
      // 保存当前音量，用于恢复
      if (videoPlayer.volume > 0) {
        videoPlayer.dataset.previousVolume = videoPlayer.volume;
      }

      if (videoPlayer.volume > 0) { // 当前非静音，执行静音操作
        videoPlayer.volume = 0;
        volumeSlider.value = 0;
        volumePercentage.textContent = '0%';
      } else { // 当前静音，执行取消静音操作
        const previousVolume = parseFloat(videoPlayer.dataset.previousVolume || 0.7); // 默认0.7
        videoPlayer.volume = previousVolume;
        volumeSlider.value = Math.round(previousVolume * 100);
        volumePercentage.textContent = Math.round(previousVolume * 100) + '%';
      }

      // 更新音量图标 (滑块旁的图标)
      if (videoPlayer.volume === 0) {
        volumeIcon.className = 'fas fa-volume-mute';
      } else if (videoPlayer.volume < 0.5) {
        volumeIcon.className = 'fas fa-volume-down';
      } else {
        volumeIcon.className = 'fas fa-volume-up';
      }

      updateMuteButtonIcon(); // 更新静音按钮图标
    }

    // --- 更新静音按钮的图标 ---
    function updateMuteButtonIcon() {
      if (muteButtonIcon) {
        if (videoPlayer.volume === 0) { // 当前已静音
          muteButtonIcon.className = 'fas fa-volume-off'; // 图标显示静音状态
        } else { // 当前非静音
          muteButtonIcon.className = 'fas fa-volume-up'; // 图标显示非静音状态
        }
      }
    }

    // --- 主题切换功能 ---
    document.getElementById('themeToggle').addEventListener('click', function () {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));

      const icon = this.querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
      } else {
        icon.className = 'fas fa-moon';
      }
    });

    // --- 加载主题设置 ---
    function loadTheme() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      const themeToggle = document.getElementById('themeToggle');
      const icon = themeToggle.querySelector('i');

      if (darkMode) {
        document.body.classList.add('dark-mode');
        icon.className = 'fas fa-sun';
      } else {
        icon.className = 'fas fa-moon';
      }
    }

    // --- 新的下载功能 ---
    async function downloadVideo() {
      const url = currentVideoUrl; // Get the currently playing video URL

      if (!url) {
        alert('没有正在播放的视频可以下载。');
        return;
      }

      // Handle local files
      if (url.startsWith('blob:')) {
        alert('当前正在播放的是本地视频，无需下载。');
        return;
      }

      updateStatus('loading', '正在准备下载...');

      try {
        const extension = getFileExtension(url);
        let filename = `video_${Date.now()}`; // Default filename

        // Try to derive a better filename from the URL
        try {
            const urlObj = new URL(url);
            const pathSegments = urlObj.pathname.split('/');
            const lastSegment = pathSegments[pathSegments.length - 1];
            if (lastSegment && lastSegment.includes('.')) {
                filename = lastSegment.split('?')[0].split('#')[0];
            } else if (extension) {
                filename += `.${extension}`;
            }
        } catch (e) {
            console.warn("Could not parse URL for filename, using default.", e);
            if (extension) {
                filename += `.${extension}`;
            }
        }

        if (extension === 'm3u8' || url.includes('.m3u8')) {
          // HLS (M3U8) download
          await downloadHLS(url, filename);
        } else if (extension === 'flv' || url.includes('.flv')) {
          // FLV download (assuming direct FLV file)
          // For FLV, if it's a direct file, a simple download works.
          // If it's a stream, it's more complex, but for VOD FLV, direct download is often possible.
          await downloadDirect(url, filename);
        } else {
          // Direct download for other formats (MP4, WebM etc.)
          await downloadDirect(url, filename);
        }
        updateStatus('playing', '下载准备完成，浏览器将开始下载。');
      } catch (error) {
        console.error('下载失败:', error);
        updateStatus('stopped', `下载失败: ${error.message || '未知错误'}`);
        alert(`下载失败: ${error.message || '未知错误'}\n请检查控制台获取更多信息。`);
      }
    }

    // Helper for direct file download
    async function downloadDirect(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename; // Suggest a filename
      document.body.appendChild(a);
      a.click();
      // Give browser a moment to initiate download before revoking
      setTimeout(() => {
          document.body.removeChild(a);
          // If it's a blob URL, revoke it (though for direct URL, browser manages)
          if (url.startsWith('blob:')) {
              URL.revokeObjectURL(url);
          }
      }, 100);
    }

    // Helper for HLS (M3U8) download
    async function downloadHLS(m3u8Url, baseFilename) {
      updateStatus('loading', '正在下载M3U8播放列表...');
      const response = await fetch(m3u8Url);
      if (!response.ok) {
        throw new Error(`Failed to fetch M3U8 manifest: ${response.statusText}`);
      }
      const manifestText = await response.text();

      const segmentUrls = [];
      const lines = manifestText.split('\n');
      const baseUrl = m3u8Url.substring(0, m3u8Url.lastIndexOf('/') + 1);

      for (const line of lines) {
        if (line.startsWith('#') || line.trim() === '') {
          continue; // Skip comments and empty lines
        }
        // Handle master playlist (if it points to other .m3u8 files)
        if (line.endsWith('.m3u8')) {
            const variantUrl = new URL(line, baseUrl).href; // Resolve relative URL
            console.log(`Found variant M3U8: ${variantUrl}. Attempting to download it.`);
            // Recursively call for the variant. This will download the first variant found.
            return downloadHLS(variantUrl, baseFilename); 
        }
        // Assume it's a segment URL
        const segmentUrl = new URL(line, baseUrl).href; // Resolve relative URL
        segmentUrls.push(segmentUrl);
      }

      if (segmentUrls.length === 0) {
        throw new Error('No video segments found in the M3u8 manifest.');
      }

      const segmentData = [];
      let downloadedBytes = 0;
      let totalSegments = segmentUrls.length;

      for (let i = 0; i < totalSegments; i++) {
        const segmentUrl = segmentUrls[i];
        updateStatus('loading', `正在下载片段 ${i + 1}/${totalSegments}...`);
        const segmentResponse = await fetch(segmentUrl);
        if (!segmentResponse.ok) {
          throw new Error(`Failed to fetch segment ${i + 1}: ${segmentResponse.statusText}`);
        }
        const buffer = await segmentResponse.arrayBuffer();
        segmentData.push(new Uint8Array(buffer));
        downloadedBytes += buffer.byteLength;
      }

      updateStatus('loading', '正在合并视频片段...');
      // Concatenate all ArrayBuffers
      const totalLength = segmentData.reduce((acc, val) => acc + val.length, 0);
      const concatenatedBuffer = new Uint8Array(totalLength);
      let offset = 0;
      for (const segment of segmentData) {
        concatenatedBuffer.set(segment, offset);
        offset += segment.length;
      }

      // Determine MIME type. For .ts segments, it's typically video/mp2t.
      const blob = new Blob([concatenatedBuffer], { type: 'video/mp2t' }); 

      const downloadLink = document.createElement('a');
      downloadLink.href = URL.createObjectURL(blob);
      // Suggest .ts extension for concatenated HLS, remove .m3u8 from original filename
      downloadLink.download = `${baseFilename.replace(/\.m3u8$/, '')}.ts`; 
      document.body.appendChild(downloadLink);
      downloadLink.click();
      setTimeout(() => {
          document.body.removeChild(downloadLink);
          URL.revokeObjectURL(downloadLink.href); // Clean up the object URL
      }, 100); // Delay revocation to ensure download starts
    }
  </script>
</body>
</html>
